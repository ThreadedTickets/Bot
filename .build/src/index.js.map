{"version":3,"file":"index.js","sources":["src/index.ts"],"sourceRoot":"/","sourcesContent":["import \"@dotenvx/dotenvx\";\r\nimport { Client, GatewayIntentBits, Options, Partials } from \"discord.js\";\r\nimport { loadPrefixCommands } from \"./handlers/commandHandler\";\r\nimport { deployAppCommands } from \"./handlers/interactionCommandHandler\";\r\nimport { loadEvents } from \"./handlers/eventHandler\";\r\nimport { connectToMongooseDatabase } from \"./database/connection\";\r\nimport { startMetricsServer } from \"./metricsServer\";\r\nimport { loadInteractionHandlers } from \"./handlers/interactionHandlers\";\r\nimport \"./utils/hooks/register\";\r\nimport { loadLanguages } from \"./lang\";\r\nimport { startApi } from \"./apiServer\";\r\nimport { InMemoryCache as MemCache } from \"./utils/database/InMemoryCache\";\r\nimport PQueue from \"p-queue\";\r\nimport { TaskScheduler as Scheduler } from \"./utils/Scheduler\";\r\nimport { closeTicket } from \"./utils/tickets/close\";\r\nimport { Locale } from \"./types/Locale\";\r\nimport { AsyncQueueManager } from \"./utils/bot/QueueManager\";\r\nimport { ClusterClient, getInfo } from \"discord-hybrid-sharding\";\r\nimport logger from \"./utils/logger\";\r\nimport \"./instrument\";\r\nimport { awaitReply } from \"./utils/tickets/await-reply\";\r\n\r\nconst isProd = process.env[\"IS_PROD\"] === \"true\";\r\n\r\nconst shardList = isProd ? getInfo().SHARD_LIST : [0];\r\nconst totalShards = isProd ? getInfo().TOTAL_SHARDS : 1;\r\n\r\nconst discordClient = new Client({\r\n  shards: shardList,\r\n  shardCount: totalShards,\r\n\r\n  intents: [\r\n    GatewayIntentBits.Guilds,\r\n    GatewayIntentBits.GuildMessages,\r\n    GatewayIntentBits.MessageContent,\r\n    GatewayIntentBits.DirectMessages,\r\n    GatewayIntentBits.GuildMembers,\r\n  ],\r\n  partials: [Partials.Channel],\r\n  makeCache: Options.cacheWithLimits({\r\n    ApplicationCommandManager: 0,\r\n    ApplicationEmojiManager: 0,\r\n    AutoModerationRuleManager: 0,\r\n    BaseGuildEmojiManager: 0,\r\n    DMMessageManager: 100,\r\n    EntitlementManager: 0,\r\n    GuildBanManager: 0,\r\n    GuildEmojiManager: 0,\r\n    GuildForumThreadManager: 0,\r\n    GuildInviteManager: 0,\r\n    GuildMemberManager: 100,\r\n    GuildMessageManager: 100,\r\n    GuildScheduledEventManager: 0,\r\n    GuildStickerManager: 0,\r\n    GuildTextThreadManager: 100,\r\n    MessageManager: 100,\r\n    PresenceManager: 0,\r\n    ReactionManager: 0,\r\n    ReactionUserManager: 0,\r\n    StageInstanceManager: 0,\r\n    ThreadManager: 100,\r\n    ThreadMemberManager: 50,\r\n    UserManager: 0,\r\n    VoiceStateManager: 0,\r\n  }),\r\n  sweepers: {\r\n    ...Options.DefaultSweeperSettings,\r\n    messages: {\r\n      interval: 3_600, // Every hour.\r\n      lifetime: 1_800, // Remove messages older than 30 minutes.\r\n    },\r\n    users: {\r\n      interval: 3_600,\r\n      filter: () => (user) => user.id !== process.env[\"DISCORD_CLIENT_ID\"], // Remove all bots.\r\n    },\r\n    threadMembers: {\r\n      interval: 3_600,\r\n      filter: () => (user) => user.id !== process.env[\"DISCORD_CLIENT_ID\"],\r\n    },\r\n    threads: {\r\n      interval: 3_600,\r\n      lifetime: 1_800,\r\n    },\r\n  },\r\n});\r\nexport const clusterClient = isProd\r\n  ? new ClusterClient(discordClient)\r\n  : discordClient;\r\n// @ts-ignore\r\nexport const client = isProd ? clusterClient.client : discordClient;\r\n\r\nloadPrefixCommands();\r\ndeployAppCommands();\r\nloadEvents(client);\r\nconnectToMongooseDatabase();\r\nstartMetricsServer(parseInt(process.env[\"METRICS_PORT\"]!, 10));\r\nstartApi(parseInt(process.env[\"API_PORT\"]!, 10));\r\nloadInteractionHandlers();\r\nloadLanguages();\r\nexport const TaskScheduler = new Scheduler();\r\nTaskScheduler.registerTaskFunction(\r\n  \"closeTicket\",\r\n  (params: { ticketId: string; locale: Locale; reason: string }) => {\r\n    closeTicket(params.ticketId, params.locale, params.reason);\r\n  }\r\n);\r\nTaskScheduler.registerTaskFunction(\r\n  \"awaitingReply\",\r\n  (params: {\r\n    ticketId: string;\r\n    action: \"nothing\" | \"lock\" | \"close\";\r\n    notify: string | null;\r\n    serverId: string;\r\n  }) => {\r\n    awaitReply(params.serverId, params.ticketId, params.action, params.notify);\r\n  }\r\n);\r\nexport const InMemoryCache = new MemCache({\r\n  defaultTTL: 1000 * 10 * 60, // 10 minutes\r\n  cleanupInterval: 1000 * 10, // 10 seconds\r\n  groupLimits: {\r\n    \"responders:\": 100,\r\n  },\r\n});\r\nexport const guildLeaveQueue = new PQueue({\r\n  concurrency: 1,\r\n  interval: 5000, // 1 second window\r\n  intervalCap: 1, // 1 task per second\r\n});\r\nexport const ticketQueueManager = new AsyncQueueManager();\r\nexport const massCloseManager = new AsyncQueueManager();\r\n\r\nexport const wait = (ms: number) => new Promise((res) => setTimeout(res, ms));\r\n\r\nclient.login(process.env[\"DISCORD_TOKEN\"]);\r\n\r\nprocess.on(\"unhandledRejection\", (err: Error) =>\r\n  logger.error(\"Unhandled Rejection\", err)\r\n);\r\nprocess.on(\"uncaughtException\", (err: Error) =>\r\n  logger.error(\"Uncaught Exception\", err)\r\n);\r\n"],"names":[],"mappings":";;;;;;;;AAAA,4BAA0B;AAC1B,2CAA0E;AAC1E,8DAA+D;AAC/D,oFAAyE;AACzE,0DAAqD;AACrD,sDAAkE;AAClE,mDAAqD;AACrD,wEAAyE;AACzE,kCAAgC;AAChC,iCAAuC;AACvC,2CAAuC;AACvC,kEAA2E;AAC3E,sDAA6B;AAC7B,iDAA+D;AAC/D,iDAAoD;AAEpD,2DAA6D;AAC7D,qEAAiE;AACjE,4DAAoC;AACpC,wBAAsB;AACtB,6DAAyD;AAEzD,MAAM,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,MAAM,CAAC;AAEjD,MAAM,SAAS,GAAG,MAAM,CAAC,CAAC,CAAC,IAAA,iCAAO,GAAE,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AACtD,MAAM,WAAW,GAAG,MAAM,CAAC,CAAC,CAAC,IAAA,iCAAO,GAAE,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC;AAExD,MAAM,aAAa,GAAG,IAAI,mBAAM,CAAC;IAC/B,MAAM,EAAE,SAAS;IACjB,UAAU,EAAE,WAAW;IAEvB,OAAO,EAAE;QACP,8BAAiB,CAAC,MAAM;QACxB,8BAAiB,CAAC,aAAa;QAC/B,8BAAiB,CAAC,cAAc;QAChC,8BAAiB,CAAC,cAAc;QAChC,8BAAiB,CAAC,YAAY;KAC/B;IACD,QAAQ,EAAE,CAAC,qBAAQ,CAAC,OAAO,CAAC;IAC5B,SAAS,EAAE,oBAAO,CAAC,eAAe,CAAC;QACjC,yBAAyB,EAAE,CAAC;QAC5B,uBAAuB,EAAE,CAAC;QAC1B,yBAAyB,EAAE,CAAC;QAC5B,qBAAqB,EAAE,CAAC;QACxB,gBAAgB,EAAE,GAAG;QACrB,kBAAkB,EAAE,CAAC;QACrB,eAAe,EAAE,CAAC;QAClB,iBAAiB,EAAE,CAAC;QACpB,uBAAuB,EAAE,CAAC;QAC1B,kBAAkB,EAAE,CAAC;QACrB,kBAAkB,EAAE,GAAG;QACvB,mBAAmB,EAAE,GAAG;QACxB,0BAA0B,EAAE,CAAC;QAC7B,mBAAmB,EAAE,CAAC;QACtB,sBAAsB,EAAE,GAAG;QAC3B,cAAc,EAAE,GAAG;QACnB,eAAe,EAAE,CAAC;QAClB,eAAe,EAAE,CAAC;QAClB,mBAAmB,EAAE,CAAC;QACtB,oBAAoB,EAAE,CAAC;QACvB,aAAa,EAAE,GAAG;QAClB,mBAAmB,EAAE,EAAE;QACvB,WAAW,EAAE,CAAC;QACd,iBAAiB,EAAE,CAAC;KACrB,CAAC;IACF,QAAQ,EAAE;QACR,GAAG,oBAAO,CAAC,sBAAsB;QACjC,QAAQ,EAAE;YACR,QAAQ,EAAE,IAAK,EAAE,cAAc;YAC/B,QAAQ,EAAE,IAAK,EAAE,yCAAyC;SAC3D;QACD,KAAK,EAAE;YACL,QAAQ,EAAE,IAAK;YACf,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,EAAE,KAAK,OAAO,CAAC,GAAG,CAAC,mBAAmB,CAAC,EAAE,mBAAmB;SAC1F;QACD,aAAa,EAAE;YACb,QAAQ,EAAE,IAAK;YACf,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,EAAE,KAAK,OAAO,CAAC,GAAG,CAAC,mBAAmB,CAAC;SACrE;QACD,OAAO,EAAE;YACP,QAAQ,EAAE,IAAK;YACf,QAAQ,EAAE,IAAK;SAChB;KACF;CACF,CAAC,CAAC;AACU,QAAA,aAAa,GAAG,MAAM;IACjC,CAAC,CAAC,IAAI,uCAAa,CAAC,aAAa,CAAC;IAClC,CAAC,CAAC,aAAa,CAAC;AAClB,aAAa;AACA,QAAA,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC,qBAAa,CAAC,MAAM,CAAC,CAAC,CAAC,aAAa,CAAC;AAEpE,IAAA,mCAAkB,GAAE,CAAC;AACrB,IAAA,6CAAiB,GAAE,CAAC;AACpB,IAAA,yBAAU,EAAC,cAAM,CAAC,CAAC;AACnB,IAAA,sCAAyB,GAAE,CAAC;AAC5B,IAAA,kCAAkB,EAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAE,EAAE,EAAE,CAAC,CAAC,CAAC;AAC/D,IAAA,oBAAQ,EAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,CAAE,EAAE,EAAE,CAAC,CAAC,CAAC;AACjD,IAAA,6CAAuB,GAAE,CAAC;AAC1B,IAAA,oBAAa,GAAE,CAAC;AACH,QAAA,aAAa,GAAG,IAAI,yBAAS,EAAE,CAAC;AAC7C,qBAAa,CAAC,oBAAoB,CAChC,aAAa,EACb,CAAC,MAA4D,EAAE,EAAE;IAC/D,IAAA,mBAAW,EAAC,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;AAC7D,CAAC,CACF,CAAC;AACF,qBAAa,CAAC,oBAAoB,CAChC,eAAe,EACf,CAAC,MAKA,EAAE,EAAE;IACH,IAAA,wBAAU,EAAC,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;AAC7E,CAAC,CACF,CAAC;AACW,QAAA,aAAa,GAAG,IAAI,6BAAQ,CAAC;IACxC,UAAU,EAAE,IAAI,GAAG,EAAE,GAAG,EAAE,EAAE,aAAa;IACzC,eAAe,EAAE,IAAI,GAAG,EAAE,EAAE,aAAa;IACzC,WAAW,EAAE;QACX,aAAa,EAAE,GAAG;KACnB;CACF,CAAC,CAAC;AACU,QAAA,eAAe,GAAG,IAAI,iBAAM,CAAC;IACxC,WAAW,EAAE,CAAC;IACd,QAAQ,EAAE,IAAI,EAAE,kBAAkB;IAClC,WAAW,EAAE,CAAC,EAAE,oBAAoB;CACrC,CAAC,CAAC;AACU,QAAA,kBAAkB,GAAG,IAAI,gCAAiB,EAAE,CAAC;AAC7C,QAAA,gBAAgB,GAAG,IAAI,gCAAiB,EAAE,CAAC;AAEjD,MAAM,IAAI,GAAG,CAAC,EAAU,EAAE,EAAE,CAAC,IAAI,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC;AAAjE,QAAA,IAAI,QAA6D;AAE9E,cAAM,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,CAAC;AAE3C,OAAO,CAAC,EAAE,CAAC,oBAAoB,EAAE,CAAC,GAAU,EAAE,EAAE,CAC9C,gBAAM,CAAC,KAAK,CAAC,qBAAqB,EAAE,GAAG,CAAC,CACzC,CAAC;AACF,OAAO,CAAC,EAAE,CAAC,mBAAmB,EAAE,CAAC,GAAU,EAAE,EAAE,CAC7C,gBAAM,CAAC,KAAK,CAAC,oBAAoB,EAAE,GAAG,CAAC,CACxC,CAAC","debug_id":"654608c3-ae3d-5644-b17d-b607b87a4301"}