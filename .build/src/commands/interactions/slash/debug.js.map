{"version":3,"file":"debug.js","sources":["src/commands/interactions/slash/debug.ts"],"sourceRoot":"/","sourcesContent":["import {\n  GuildMember,\n  InteractionContextType,\n  MessageFlags,\n  PermissionFlagsBits,\n  SlashCommandBuilder,\n} from \"discord.js\";\nimport { AppCommand } from \"../../../types/Command\";\nimport { getUserPermissions } from \"../../../utils/calculateUserPermissions\";\nimport {\n  getServerGroups,\n  getServerGroupsByIds,\n  getUserTickets,\n} from \"../../../utils/bot/getServer\";\nimport colours from \"../../../constants/colours\";\nimport { t } from \"../../../lang\";\nimport { massCloseManager } from \"../../..\";\nimport { closeTicket } from \"../../../utils/tickets/close\";\nimport { invalidateCache } from \"../../../utils/database/invalidateCache\";\nimport { formatDuration } from \"../../../utils/formatters/duration\";\n\nconst command: AppCommand = {\n  type: \"slash\",\n  data: new SlashCommandBuilder()\n    .setName(\"debug\")\n    .setDescription(\"Threaded debugger\")\n    .setDefaultMemberPermissions(PermissionFlagsBits.ManageMessages)\n    .setContexts(InteractionContextType.Guild)\n    .setNameLocalizations({})\n    .setDescriptionLocalizations({})\n    .addSubcommand((cmd) =>\n      cmd\n        .setName(\"group_permissions\")\n        .setDescription(\"Debug your group permissions\")\n        .setNameLocalizations({})\n        .setDescriptionLocalizations({})\n        .addUserOption((opt) =>\n          opt.setName(\"user\").setDescription(\"The user to check\")\n        )\n    )\n    .addSubcommand((cmd) =>\n      cmd\n        .setName(\"close_all_tickets\")\n        .setDescription(\"If a user is having problems, close ALL their tickets\")\n        .setNameLocalizations({})\n        .setDescriptionLocalizations({})\n        .addUserOption((opt) =>\n          opt\n            .setName(\"user\")\n            .setDescription(\"The user to check\")\n            .setRequired(true)\n        )\n    ),\n\n  async execute(client, data, interaction) {\n    if (!interaction.guildId) return;\n    await interaction.reply({\n      content: t(data.lang!, \"THINK\"),\n      flags: [MessageFlags.Ephemeral],\n    });\n\n    const subcommand = interaction.options.getSubcommand(true);\n\n    if (subcommand === \"group_permissions\") {\n      const member =\n        interaction.options.getMember(\"user\") || interaction.member;\n      const permissions = getUserPermissions(\n        member as GuildMember,\n        await getServerGroups(interaction.guildId)\n      );\n\n      interaction.editReply({\n        embeds: [\n          {\n            color: parseInt(colours.info, 16),\n            title: t(data.lang!, \"DEBUGGER_GROUP_PERMISSIONS_TITLE\"),\n            description: t(data.lang!, \"DEBUGGER_GROUP_PERMISSIONS_BODY\"),\n          },\n          {\n            color: parseInt(colours.info, 16),\n            description: `\\`\\`\\`json\\n${JSON.stringify(\n              permissions,\n              (_, v) => (typeof v === \"bigint\" ? v.toString() : v),\n              2\n            )}\\n\\`\\`\\``,\n          },\n        ],\n      });\n    } else if (subcommand === \"close_all_tickets\") {\n      const start = new Date().getTime();\n      const user = interaction.options.getUser(\"user\", true);\n      await invalidateCache(\n        `tickets:${interaction.guildId!}:${user.id}:Locked|Open`\n      );\n      const userTickets = await getUserTickets(interaction.guildId, user.id, [\n        \"Open\",\n        \"Locked\",\n      ]);\n\n      let failed = userTickets.length;\n      interaction.editReply({\n        content: t(data.lang!, \"CLOSE_MASS_ACTION\", {\n          number: userTickets.length,\n          user: `<@${user.id}>`,\n        }),\n      });\n\n      for (const ticket of userTickets) {\n        const a = await massCloseManager.wrap(async () => {\n          const userPermissions = getUserPermissions(\n            interaction.member as GuildMember,\n            await getServerGroupsByIds(ticket.groups, interaction.guildId!)\n          );\n\n          if (\n            !userPermissions.tickets.canClose &&\n            !interaction.memberPermissions?.has(PermissionFlagsBits.ManageGuild)\n          )\n            return false;\n          await closeTicket(ticket._id, data.lang!);\n          return true;\n        }, interaction.guildId);\n        if (a) failed--;\n      }\n\n      interaction.editReply({\n        content: t(data.lang!, \"CLOSE_MASS_ACTION_DONE\", {\n          number: userTickets.length - failed,\n          user: `<@${user.id}>`,\n          failed: failed,\n          duration: formatDuration(new Date().getTime() - start),\n        }),\n      });\n    }\n  },\n};\n\nexport default command;\n"],"names":[],"mappings":"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","debug_id":"1fbdaa6c-5f92-5425-911e-8bace5c51c75"}