{"version":3,"file":"apply.js","sources":["src/commands/interactions/slash/apply.ts"],"sourceRoot":"/","sourcesContent":["import {\n  GuildMember,\n  InteractionContextType,\n  MessageFlags,\n  SlashCommandBuilder,\n} from \"discord.js\";\nimport { AppCommand } from \"../../../types/Command\";\nimport {\n  getServerApplication,\n  getServerApplications,\n} from \"../../../utils/bot/getServer\";\nimport { onError } from \"../../../utils/onError\";\nimport { t } from \"../../../lang\";\nimport { performApplicationChecks } from \"../../../utils/applications/performChecks\";\nimport { runHooks } from \"../../../utils/hooks\";\nimport { Application } from \"../../../types/Application\";\n\nconst command: AppCommand = {\n  type: \"slash\",\n  data: new SlashCommandBuilder()\n    .setName(\"apply\")\n    .setDescription(\"Apply for an application\")\n    .setContexts(InteractionContextType.Guild)\n    .setNameLocalizations({})\n    .setDescriptionLocalizations({})\n    .addStringOption((opt) =>\n      opt\n        .setName(\"application\")\n        .setDescription(\"Which application would you like to apply for?\")\n        .setRequired(true)\n        .setNameLocalizations({})\n        .setDescriptionLocalizations({})\n        .setAutocomplete(true)\n    ),\n\n  async autocomplete(client, interaction) {\n    if (!interaction.guildId) return;\n    const focused = interaction.options.getFocused(true).name;\n\n    if (focused === \"application\") {\n      const focusedValue = interaction.options.getString(\"application\", true);\n      const now = new Date().getTime();\n      const applications = (\n        await getServerApplications(interaction.guildId)\n      ).filter((app) => {\n        const open = app.open ? new Date(app.open).getTime() : null;\n        const close = app.close ? new Date(app.close).getTime() : null;\n        const accepting = app.acceptingResponses;\n\n        if (open && close && !accepting) {\n          // Only show if now is between open and close\n          return now >= open && now <= close;\n        }\n\n        if (close && accepting) {\n          // Do not show if close date has passed\n          return now <= close;\n        }\n\n        if (open && accepting) {\n          // Show\n          return true;\n        }\n\n        if (open && !accepting) {\n          // Show if past open\n          return now >= open;\n        }\n\n        if (!open && !close && accepting) {\n          // Show\n          return true;\n        }\n\n        // If none set and not accepting, do not show\n        return false;\n      });\n      if (!applications.length) {\n        interaction.respond([\n          {\n            name: \"There are no open applications!\",\n            value: \"\",\n          },\n        ]);\n        return;\n      }\n\n      const filtered = applications.filter((m) =>\n        m.name.toLowerCase().includes(focusedValue.toLowerCase())\n      );\n\n      interaction.respond(\n        filtered\n          .map((m) => ({\n            name: m.name,\n            value: m._id,\n          }))\n          .slice(0, 25)\n      );\n    }\n  },\n\n  async execute(client, data, interaction) {\n    if (!interaction.guildId) return;\n\n    await interaction.reply({\n      content: t(data.lang!, \"APPLICATION_PENDING_CHECKS\"),\n      flags: [MessageFlags.Ephemeral],\n    });\n\n    const application = await getServerApplication(\n      interaction.options.getString(\"application\", true),\n      interaction.guildId\n    );\n    if (!application)\n      return interaction.editReply(\n        (await onError(new Error(\"Application not found\"))).discordMsg\n      );\n\n    const appObject = application.toObject();\n    const applicationTyped: Application = {\n      ...appObject,\n      open: appObject.open?.toISOString() ?? null,\n      close: appObject.close?.toISOString() ?? null,\n      acceptedMessage: appObject.acceptedMessage ?? null,\n      rejectedMessage: appObject.rejectedMessage ?? null,\n      submissionMessage: appObject.submissionMessage ?? null,\n      cancelMessage: appObject.cancelMessage ?? null,\n      confirmationMessage: appObject.confirmationMessage ?? null,\n    };\n\n    const checks = await performApplicationChecks(\n      applicationTyped,\n      interaction.member as GuildMember,\n      true\n    );\n\n    if (!checks.allowed) {\n      return interaction.editReply(\n        (await onError(new Error(t(data.lang!, `ERROR_CODE_${checks.error}`))))\n          .discordMsg\n      );\n    }\n\n    interaction.editReply({\n      content: t(data.lang!, \"APPLICATION_DIRECT_TO_DMS\"),\n    });\n\n    runHooks(\"ApplicationStart\", {\n      lang: data.lang!,\n      user: interaction.user,\n      application: applicationTyped,\n      server: interaction.guild!,\n    });\n  },\n};\n\nexport default command;\n"],"names":[],"mappings":"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","debug_id":"d58f18a5-04d9-5eb0-84dd-6062cd4819c0"}