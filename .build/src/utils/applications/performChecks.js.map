{"version":3,"file":"performChecks.js","sources":["src/utils/applications/performChecks.ts"],"sourceRoot":"/","sourcesContent":["import { GuildMember, User } from \"discord.js\";\nimport {\n  getCompletedApplications,\n  getUserCompletedApplications,\n} from \"../bot/getServer\";\nimport { Application } from \"../../types/Application\";\nimport { getCache } from \"../database/getCachedElse\";\n\n/**\n *\n * @param application\n * @param member\n * @returns\n * Error 1001: User has blacklisted role\n *\n * Error 1002: User doesn't have all required roles\n *\n * Error 1003: Application limit (all users) has been reached\n *\n * Error 1004: User at application limit\n *\n * Error 1005: User on cooldown\n *\n * Error 1006: Application is not currently accepting responses\n *\n * Error 1007: Other active application\n */\nexport async function performApplicationChecks(\n  application: Application,\n  member: GuildMember | User,\n  checkForActiveApplications?: boolean,\n  includeRoles?: boolean\n): Promise<{\n  allowed: boolean;\n  error: \"1001\" | \"1002\" | \"1003\" | \"1004\" | \"1005\" | \"1006\" | \"1007\" | null;\n}> {\n  const {\n    allowedAttempts,\n    blacklistRoles,\n    requiredRoles,\n    applicationLimit,\n    applicationCooldown,\n    acceptingResponses,\n    open,\n    close,\n  } = application;\n\n  if (\n    checkForActiveApplications &&\n    (await getCache(`runningApplications:${member.id}`)).cached\n  )\n    return {\n      allowed: false,\n      error: \"1007\",\n    };\n\n  const now = Date.now();\n  const openTime = open ? new Date(open).getTime() : null;\n  const closeTime = close ? new Date(close).getTime() : null;\n\n  // Time window checks (Error 6)\n  if (openTime && closeTime && !acceptingResponses) {\n    if (!(now >= openTime && now <= closeTime)) {\n      return { allowed: false, error: \"1006\" };\n    }\n  } else if (closeTime && acceptingResponses) {\n    if (now > closeTime) {\n      return { allowed: false, error: \"1006\" };\n    }\n  } else if (openTime && !acceptingResponses) {\n    if (now < openTime) {\n      return { allowed: false, error: \"1006\" };\n    }\n  } else if (!openTime && !closeTime && !acceptingResponses) {\n    return { allowed: false, error: \"1006\" };\n  }\n\n  // Role checks\n  if (\n    includeRoles &&\n    \"roles\" in member &&\n    member.roles.cache.hasAny(...blacklistRoles)\n  )\n    return {\n      allowed: false,\n      error: \"1001\",\n    };\n\n  if (\n    includeRoles &&\n    \"roles\" in member &&\n    !member.roles.cache.hasAll(...requiredRoles)\n  )\n    return {\n      allowed: false,\n      error: \"1002\",\n    };\n\n  // Global application limit (Pending only)\n  const completedApplications = await getCompletedApplications(\n    application._id,\n    [\"Pending\"]\n  );\n\n  if (applicationLimit > 0 && completedApplications.length >= applicationLimit)\n    return {\n      allowed: false,\n      error: \"1003\",\n    };\n\n  // User-specific applications\n  const userCompletedApplications = await getUserCompletedApplications(\n    application._id,\n    member.id\n  );\n\n  const userPending = userCompletedApplications.filter(\n    (a) => a.status === \"Pending\"\n  );\n\n  if (allowedAttempts > 0 && userPending.length >= allowedAttempts) {\n    return {\n      allowed: false,\n      error: \"1004\",\n    };\n  }\n\n  // Cooldown (non-pending only)\n  if (applicationCooldown > 0) {\n    const cooldownMs = applicationCooldown * 60 * 1000;\n\n    const recentCompleted = userCompletedApplications.find(\n      (a) =>\n        a.status !== \"Pending\" &&\n        a.closedAt &&\n        now - new Date(a.closedAt).getTime() < cooldownMs\n    );\n\n    if (recentCompleted) {\n      return {\n        allowed: false,\n        error: \"1005\",\n      };\n    }\n  }\n\n  return {\n    allowed: true,\n    error: null,\n  };\n}\n"],"names":[],"mappings":"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","debug_id":"f804dfed-365b-54e4-b08d-e72bcba8fa10"}