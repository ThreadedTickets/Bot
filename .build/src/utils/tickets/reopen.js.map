{"version":3,"file":"reopen.js","sources":["src/utils/tickets/reopen.ts"],"sourceRoot":"/","sourcesContent":["import {\n  ButtonInteraction,\n  ChatInputCommandInteraction,\n  TextChannel,\n} from \"discord.js\";\nimport { client, TaskScheduler } from \"../..\";\nimport { t } from \"../../lang\";\nimport { Locale } from \"../../types/Locale\";\nimport { TicketSchema } from \"../../database/modals/Ticket\";\nimport { getServer, getServerGroupsByIds } from \"../bot/getServer\";\nimport {\n  getAvailableLogChannel,\n  postLogToWebhook,\n} from \"../bot/sendLogToWebhook\";\nimport colours from \"../../constants/colours\";\nimport { fetchChannelById } from \"../bot/fetchMessage\";\nimport { onError } from \"../onError\";\nimport { invalidateCache } from \"../database/invalidateCache\";\nimport { buildChannelPermissionOverwrites } from \"../hooks/events/tickets/new/main\";\nimport everyoneTicketPermissions from \"../../constants/everyoneTicketPermissions\";\nimport botTicketPermissions from \"../../constants/botTicketPermissions\";\nimport ticketOwnerPermissions from \"../../constants/ticketOwnerPermissions\";\nimport { updateMemberRoles } from \"../hooks/events/applications/end/roles\";\nimport { getGuildMember } from \"../bot/getGuildMember\";\nimport logger from \"../logger\";\n\nexport async function reopenTicket(\n  ticketId: string,\n  locale: Locale,\n  repliable: ButtonInteraction | ChatInputCommandInteraction\n) {\n  const ticket = await TicketSchema.findOneAndUpdate(\n    { _id: ticketId },\n    {\n      status: \"Open\",\n    },\n    {\n      new: false,\n    }\n  );\n  await invalidateCache(`ticket:${ticketId}`);\n  if (!ticket)\n    return repliable?.editReply(\n      (\n        await onError(new Error(\"Could not find ticket\"), {\n          ticketId: ticketId,\n        })\n      ).discordMsg\n    );\n  invalidateCache(`tickets:${ticket.server}:${ticket.owner}:Open`);\n  invalidateCache(`tickets:${ticket.server}:Open`);\n  if (!ticket.allowReopening)\n    return repliable?.editReply(t(locale, \"REOPEN_NOT_SUPPORTED\"));\n  if (ticket.status === \"Open\")\n    return repliable?.editReply(t(locale, \"TICKET_ALREADY_OPEN\"));\n\n  const ticketChannel = await fetchChannelById(client, ticket.channel);\n  const member = await getGuildMember(client, ticket.server, ticket.owner);\n\n  if (member)\n    updateMemberRoles(\n      client,\n      member,\n      [...ticket.removeRolesOnClose, ...ticket.addRolesOnOpen],\n      [...ticket.addRolesOnClose, ...ticket.removeRolesOnOpen]\n    );\n\n  const server = await getServer(ticket.server);\n  const logChannel = getAvailableLogChannel(\n    server.settings.logging,\n    \"tickets.open\"\n  );\n  if (logChannel)\n    await postLogToWebhook(\n      client,\n      {\n        channel: logChannel.channel!,\n        enabled: logChannel.enabled,\n        webhook: logChannel.webhook!,\n      },\n      {\n        embeds: [\n          {\n            color: parseInt(colours.info, 16),\n            title: t(server.preferredLanguage, \"TICKET_REOPEN_LOG_TITLE\"),\n            description: t(server.preferredLanguage, `TICKET_REOPEN_LOG_BODY`, {\n              user: `<@${ticket.owner}>`,\n            }),\n          },\n        ],\n      }\n    );\n\n  if (!ticketChannel?.isThread()) {\n    await (ticketChannel as TextChannel)\n      .edit({\n        permissionOverwrites: buildChannelPermissionOverwrites(\n          await getServerGroupsByIds(ticket.groups, ticket.server),\n          ticket.server,\n          { id: ticket.owner, ...ticketOwnerPermissions },\n          everyoneTicketPermissions,\n          { id: client.user!.id, ...botTicketPermissions }\n        ),\n      })\n      .catch((err) =>\n        logger.warn(`Failed to edit ticket channel on reopen`, err)\n      );\n  }\n\n  TaskScheduler.removeTask(`CLOSE-${ticketId}`);\n  repliable?.editReply(t(locale, \"TICKET_REOPEN\"));\n\n  if (ticketChannel?.isTextBased())\n    (ticketChannel as TextChannel)\n      .send({\n        content: t(locale, \"TICKET_REOPEN\"),\n      })\n      .catch((err) =>\n        logger.warn(`Failed to send message to ticket channel on reopen`, err)\n      );\n  else if (ticketChannel?.isThread()) {\n    await ticketChannel.members\n      .add(ticket.owner)\n      .catch((err) => logger.warn(`Failed to add ticket owner on reopen`, err));\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"a2b32a48-5798-5b9d-9786-49c7df972b4a"}