{"version":3,"file":"lower.js","sources":["src/utils/tickets/lower.ts"],"sourceRoot":"/","sourcesContent":["import {\n  ActionRowBuilder,\n  ButtonBuilder,\n  ButtonInteraction,\n  ButtonStyle,\n  ChatInputCommandInteraction,\n  TextChannel,\n} from \"discord.js\";\nimport { client } from \"../..\";\nimport { t } from \"../../lang\";\nimport { Locale } from \"../../types/Locale\";\nimport { getServer, getTicketTrust } from \"../bot/getServer\";\nimport {\n  getAvailableLogChannel,\n  postLogToWebhook,\n} from \"../bot/sendLogToWebhook\";\nimport colours from \"../../constants/colours\";\nimport { fetchChannelById } from \"../bot/fetchMessage\";\nimport { onError } from \"../onError\";\nimport { TicketSchema } from \"../../database/modals/Ticket\";\nimport { invalidateCache } from \"../database/invalidateCache\";\nimport logger from \"../logger\";\n\nexport async function lowerTicket(\n  ticketId: string,\n  locale: Locale,\n  repliable: ButtonInteraction | ChatInputCommandInteraction\n) {\n  const ticket = await getTicketTrust(ticketId);\n  if (!ticket)\n    return repliable?.editReply(\n      (\n        await onError(new Error(\"Could not find ticket\"), {\n          ticketId: ticketId,\n        })\n      ).discordMsg\n    );\n  if (!ticket.isRaised)\n    return repliable?.editReply(t(locale, \"TICKET_ALREADY_LOWERED\"));\n  if (!ticket.allowRaising)\n    return repliable?.editReply(t(locale, \"TICKET_DOES_NOT_ALLOW_RAISE\"));\n\n  await TicketSchema.findOneAndUpdate({ _id: ticketId }, { isRaised: false });\n  await invalidateCache(`ticket:${ticketId}`);\n  await invalidateCache(`ticketTrust:${ticketId}`);\n\n  const ticketChannel = await fetchChannelById(client, ticket.channel);\n\n  const server = await getServer(ticket.server);\n  const logChannel = getAvailableLogChannel(\n    server.settings.logging,\n    \"tickets.lower\"\n  );\n  if (logChannel)\n    await postLogToWebhook(\n      client,\n      {\n        channel: logChannel.channel!,\n        enabled: logChannel.enabled,\n        webhook: logChannel.webhook!,\n      },\n      {\n        embeds: [\n          {\n            color: parseInt(colours.info, 16),\n            title: t(server.preferredLanguage, \"TICKET_LOWER_LOG_TITLE\"),\n            description: t(server.preferredLanguage, `TICKET_LOWER_LOG_BODY`, {\n              user: `<@${ticket.owner}>`,\n            }),\n          },\n        ],\n      }\n    );\n\n  repliable?.editReply(t(locale, \"TICKET_LOWERED\"));\n\n  if (ticketChannel?.isTextBased())\n    (ticketChannel as TextChannel)\n      .send({\n        content: t(locale, \"TICKET_LOWERED\"),\n        components: [\n          new ActionRowBuilder<ButtonBuilder>().setComponents(\n            new ButtonBuilder()\n              .setCustomId(`raise:${ticketId}`)\n              .setStyle(ButtonStyle.Primary)\n              .setLabel(t(locale, \"TICKET_PIN_MESSAGE_COMPONENTS_RAISE\"))\n          ),\n        ],\n      })\n      .catch((err) =>\n        logger.warn(`Failed to send message to ticket channel on lower`, err)\n      );\n}\n"],"names":[],"mappings":"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","debug_id":"d2eb66e3-87ca-5a49-9354-0d3f20149900"}