{"version":3,"file":"performChecks.js","sources":["src/utils/tickets/performChecks.ts"],"sourceRoot":"/","sourcesContent":["import {\n  ChannelType,\n  Guild,\n  GuildBasedChannel,\n  GuildMember,\n  PermissionsBitField,\n  User,\n} from \"discord.js\";\nimport { TicketTrigger } from \"../../types/Ticket\";\nimport { getTickets, getUserTickets } from \"../bot/getServer\";\n\nexport async function performTicketChecks(\n  trigger: TicketTrigger,\n  member: GuildMember | User\n): Promise<{\n  allowed: boolean;\n  error: null | \"2001\" | \"2002\" | \"2003\" | \"2004\";\n}> {\n  const { bannedRoles, requiredRoles, userLimit, serverLimit } = trigger;\n\n  // Role checks\n  if (\"roles\" in member && member.roles.cache.hasAny(...bannedRoles))\n    return {\n      allowed: false,\n      error: \"2001\",\n    };\n\n  if (\"roles\" in member && !member.roles.cache.hasAll(...requiredRoles))\n    return {\n      allowed: false,\n      error: \"2002\",\n    };\n\n  const openTickets = await getTickets(trigger.server, [\"Open\"]);\n\n  if (serverLimit > 0 && openTickets.length >= serverLimit)\n    return {\n      allowed: false,\n      error: \"2003\",\n    };\n\n  // User-specific applications\n  const userOpenTickets = await getUserTickets(trigger.server, member.id, [\n    \"Open\",\n  ]);\n\n  if (userLimit > 0 && userOpenTickets.length >= userLimit) {\n    return {\n      allowed: false,\n      error: \"2004\",\n    };\n  }\n\n  return {\n    allowed: true,\n    error: null,\n  };\n}\n\nexport async function canCreateTicketTarget(\n  guild: Guild,\n  type: \"channel\" | \"thread\",\n  parentId?: string | null\n): Promise<{ allowed: boolean; error?: string }> {\n  // Check guild-wide channel limit\n  const allChannels = await guild.channels.fetch();\n  const totalChannels = allChannels.size;\n\n  if (type === \"channel\" && totalChannels >= 500) {\n    return {\n      allowed: false,\n      error: \"2005\",\n    };\n  }\n\n  let parent: GuildBasedChannel | null = null;\n  if (parentId) {\n    try {\n      parent = await guild.channels.fetch(parentId);\n    } catch {\n      return { allowed: false, error: \"2006\" };\n    }\n\n    if (!parent) {\n      return { allowed: false, error: \"2007\" };\n    }\n  }\n\n  // If creating a channel inside a category\n  if (type === \"channel\" && parent?.type === ChannelType.GuildCategory) {\n    const children = parent.children.cache.size;\n    if (children >= 50) {\n      return {\n        allowed: false,\n        error: \"2008\",\n      };\n    }\n  }\n\n  // If creating a thread\n  if (type === \"thread\") {\n    if (!parent || parent.type !== ChannelType.GuildText) {\n      return {\n        allowed: false,\n        error: \"2009\",\n      };\n    }\n\n    // This stupid thing seems to be pumping out errors, there should be plenty of other error handling\n    // const permissions = parent.permissionsFor(guild.members.me!);\n    // if (!permissions?.has(PermissionsBitField.Flags.CreatePrivateThreads)) {\n    //   return {\n    //     allowed: false,\n    //     error: \"2010\",\n    //   };\n    // }\n\n    const threads = await parent.threads.fetchActive();\n    if (threads.threads.size >= 1000) {\n      return { allowed: false, error: \"2011\" };\n    }\n  }\n\n  // Permissions to create regular channels\n  const permissions = guild.members.me?.permissions;\n  if (\n    type === \"channel\" &&\n    !permissions?.has(PermissionsBitField.Flags.ManageChannels)\n  ) {\n    return { allowed: false, error: \"2012\" };\n  }\n\n  return { allowed: true };\n}\n"],"names":[],"mappings":"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","debug_id":"9715fc19-7d31-57f4-a0df-a48b71141f1c"}