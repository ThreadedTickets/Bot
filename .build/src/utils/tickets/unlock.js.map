{"version":3,"file":"unlock.js","sources":["src/utils/tickets/unlock.ts"],"sourceRoot":"/","sourcesContent":["import {\n  ButtonInteraction,\n  ChatInputCommandInteraction,\n  TextChannel,\n} from \"discord.js\";\nimport { client } from \"../..\";\nimport { t } from \"../../lang\";\nimport { Locale } from \"../../types/Locale\";\nimport {\n  getServer,\n  getServerGroupsByIds,\n  getTicketTrust,\n} from \"../bot/getServer\";\nimport {\n  getAvailableLogChannel,\n  postLogToWebhook,\n} from \"../bot/sendLogToWebhook\";\nimport colours from \"../../constants/colours\";\nimport { fetchChannelById } from \"../bot/fetchMessage\";\nimport { onError } from \"../onError\";\nimport { buildChannelPermissionOverwrites } from \"../hooks/events/tickets/new/main\";\nimport everyoneTicketPermissions from \"../../constants/everyoneTicketPermissions\";\nimport botTicketPermissions from \"../../constants/botTicketPermissions\";\nimport { TicketSchema } from \"../../database/modals/Ticket\";\nimport { invalidateCache } from \"../database/invalidateCache\";\nimport ticketOwnerPermissions from \"../../constants/ticketOwnerPermissions\";\nimport logger from \"../logger\";\n\nexport async function unlockTicket(\n  ticketId: string,\n  locale: Locale,\n  repliable: ButtonInteraction | ChatInputCommandInteraction\n) {\n  const ticket = await getTicketTrust(ticketId);\n  if (!ticket)\n    return repliable?.editReply(\n      (\n        await onError(new Error(\"Could not find ticket\"), {\n          ticketId: ticketId,\n        })\n      ).discordMsg\n    );\n  invalidateCache(`tickets:${ticket.server}:${ticket.owner}:Open`);\n  invalidateCache(`tickets:${ticket.server}:Open`);\n  if (ticket.status !== \"Locked\")\n    return repliable?.editReply(t(locale, \"TICKET_NOT_LOCKED\"));\n\n  await TicketSchema.findOneAndUpdate({ _id: ticketId }, { status: \"Open\" });\n  await invalidateCache(`ticket:${ticketId}`);\n  await invalidateCache(`ticketTrust:${ticketId}`);\n\n  const ticketChannel = await fetchChannelById(client, ticket.channel);\n  const server = await getServer(ticket.server);\n  const logChannel = getAvailableLogChannel(\n    server.settings.logging,\n    \"tickets.unlock\"\n  );\n  if (logChannel)\n    await postLogToWebhook(\n      client,\n      {\n        channel: logChannel.channel!,\n        enabled: logChannel.enabled,\n        webhook: logChannel.webhook!,\n      },\n      {\n        embeds: [\n          {\n            color: parseInt(colours.info, 16),\n            title: t(server.preferredLanguage, \"TICKET_UNLOCK_LOG_TITLE\"),\n            description: t(server.preferredLanguage, `TICKET_UNLOCK_LOG_BODY`, {\n              user: `<@${ticket.owner}>`,\n            }),\n          },\n        ],\n      }\n    );\n\n  if (!ticketChannel?.isThread()) {\n    await (ticketChannel as TextChannel)\n      .edit({\n        permissionOverwrites: buildChannelPermissionOverwrites(\n          await getServerGroupsByIds(ticket.groups, ticket.server),\n          ticket.server,\n          { id: ticket.owner, ...ticketOwnerPermissions },\n          everyoneTicketPermissions,\n          { id: client.user!.id, ...botTicketPermissions }\n        ),\n      })\n      .catch((err) =>\n        logger.warn(`Failed to edit ticket channel on unlock`, err)\n      );\n  } else if (ticketChannel?.isThread()) {\n    await ticketChannel.members\n      .add(ticket.owner)\n      .catch((err) => logger.warn(`Failed to add ticket owner on unlock`, err));\n  }\n\n  repliable?.editReply(t(locale, \"TICKET_UNLOCK\"));\n\n  if (ticketChannel?.isTextBased())\n    (ticketChannel as TextChannel)\n      .send({\n        content: t(locale, \"TICKET_UNLOCK\"),\n      })\n      .catch((err) =>\n        logger.warn(`Failed to send message to ticket channel on unlock`, err)\n      );\n}\n"],"names":[],"mappings":"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","debug_id":"ffee9415-e4c9-598f-af83-8b5e33e0a008"}