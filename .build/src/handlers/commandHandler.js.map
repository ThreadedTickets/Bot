{"version":3,"file":"commandHandler.js","sources":["src/handlers/commandHandler.ts"],"sourceRoot":"/","sourcesContent":["import { Collection, Client, Message, APIEmbed } from \"discord.js\";\r\nimport { PrefixCommand } from \"../types/Command\";\r\nimport path from \"node:path\";\r\nimport { parseArgs } from \"../utils/commands/message/argumentParser\";\r\nimport config from \"../config\";\r\nimport { loadFilesRecursively } from \"../utils/commands/load\";\r\nimport { checkCommandPermissions } from \"../utils/commands/permissions\";\r\nimport colours from \"../constants/colours\";\r\nimport { commandErrors, commandsRun } from \"../metricsServer\";\r\nimport { onError } from \"../utils/onError\";\r\nimport { permissionLevels } from \"../constants/permissions\";\r\nimport { t } from \"../lang\";\r\nimport { getCache } from \"../utils/database/getCachedElse\";\r\nimport { EventData } from \"./eventHandler\";\r\nimport logger from \"../utils/logger\";\r\n\r\nconst prefix = config.prefix;\r\n\r\nconst prefixCommands = new Collection<string, PrefixCommand<object, any>>();\r\n\r\nexport const loadPrefixCommands = async () => {\r\n  const commandFiles = loadFilesRecursively(\r\n    path.join(__dirname, \"../commands/prefix\")\r\n  );\r\n\r\n  let totalCommands: number = 0;\r\n  let totalAliases: number = 0;\r\n\r\n  for (const file of commandFiles) {\r\n    const command: PrefixCommand = (await import(file)).default;\r\n    prefixCommands.set(command.name, command);\r\n    totalCommands++;\r\n\r\n    command.aliases?.forEach((alias) => {\r\n      if (prefixCommands.has(alias)) {\r\n        logger.warn(`${alias} has already been registered`);\r\n        return;\r\n      }\r\n      prefixCommands.set(alias, command);\r\n      totalAliases++;\r\n    });\r\n  }\r\n\r\n  logger.info(\r\n    `Loaded ${totalCommands} prefix commands (${totalAliases} aliases)`\r\n  );\r\n};\r\n\r\nexport const handlePrefixMessage = async (\r\n  client: Client,\r\n  data: EventData,\r\n  message: Message\r\n) => {\r\n  if (!message.content.startsWith(prefix) || message.author.bot) return;\r\n\r\n  const blacklists = await Promise.all([\r\n    getCache(`blacklists:${message.author.id}`),\r\n    getCache(`blacklists:${message.guildId}`),\r\n  ]);\r\n\r\n  if (blacklists[0].cached || blacklists[1].cached) {\r\n    // We know the user is blacklisted, im gonna just use en as locale as this is per-user not server\r\n    message.author\r\n      .send(\r\n        (\r\n          await onError(\r\n            new Error(\r\n              t(\r\n                // (\r\n                //   await getServer(interaction.guildId)\r\n                // ).preferredLanguage,\r\n                \"en\",\r\n                `BLACKLISTED_${blacklists[0].cached ? \"USER\" : \"SERVER\"}`,\r\n                {\r\n                  reason:\r\n                    (blacklists[0].data as string) ||\r\n                    (blacklists[1].data as string),\r\n                }\r\n              )\r\n            )\r\n          )\r\n        ).discordMsg\r\n      )\r\n      .catch((e) => {\r\n        logger.warn(`Failed to DM user ${message.author.id}`, e);\r\n      });\r\n    return;\r\n  }\r\n\r\n  const args = message.content.slice(prefix.length).trim().split(/ +/);\r\n  const commandName = args.shift()?.toLowerCase();\r\n  if (!commandName) return;\r\n\r\n  const command = prefixCommands.get(commandName);\r\n  if (!command) return;\r\n  commandsRun.inc({ command: commandName, type: \"Prefix\" });\r\n  if (!checkCommandPermissions(command, message.author.id)) return;\r\n  if (\r\n    (command.allowedIn === \"guilds\" || command.allowedIn === \"all\") &&\r\n    command.permissionLevel &&\r\n    !message.member?.permissions.has(permissionLevels[command.permissionLevel])\r\n  )\r\n    return;\r\n  if (command.allowedIn === \"guilds\" && !message.guild) return;\r\n  if (command.allowedIn === \"dms\" && message.guild) return;\r\n\r\n  const input = args.join(\" \");\r\n  const {\r\n    args: parsedArgs,\r\n    error,\r\n    code,\r\n    context,\r\n  } = parseArgs(command.usage, input);\r\n\r\n  if (error) {\r\n    let reply = {};\r\n\r\n    switch (code) {\r\n      case 0:\r\n        reply = {\r\n          embeds: [\r\n            {\r\n              color: parseInt(colours.error, 16),\r\n              description: `Missing required argument: \\`${context.missing}\\`\\nUsage: \\`${prefix}${command.name} ${command.usage}\\``,\r\n            },\r\n          ] as APIEmbed,\r\n        };\r\n        break;\r\n      case 1:\r\n        reply = {\r\n          embeds: [\r\n            {\r\n              color: parseInt(colours.error, 16),\r\n              description: `Invalid type: \\`${context.arg}\\` must be of type ${context.expected} (got \\`${context.received}\\`)\\nUsage: \\`${prefix}${command.name} ${command.usage}\\``,\r\n            },\r\n          ] as APIEmbed,\r\n        };\r\n        break;\r\n      case 2:\r\n        reply = {\r\n          embeds: [\r\n            {\r\n              color: parseInt(colours.error, 16),\r\n              description: `Invalid choice: \\`${\r\n                context.arg\r\n              }\\` must be one of ${context.options\r\n                .map((o: string) => `\\`${o}\\``)\r\n                .join(\",\")} (got \\`${context.received}\\`)\\nUsage: \\`${prefix}${\r\n                command.name\r\n              } ${command.usage}\\``,\r\n            },\r\n          ] as APIEmbed,\r\n        };\r\n        break;\r\n      case 3:\r\n        reply = {\r\n          embeds: [\r\n            {\r\n              color: parseInt(colours.error, 16),\r\n              description: `Too many arguments: Extra: \\`${context.extra.join(\r\n                \" \"\r\n              )}\\` (Expected ${context.expected}, got ${\r\n                context.received\r\n              })\\nUsage: \\`${prefix}${command.name} ${command.usage}\\``,\r\n            },\r\n          ] as APIEmbed,\r\n        };\r\n        break;\r\n    }\r\n    commandErrors.inc({ command: commandName, type: \"Prefix\", cause: error });\r\n    return message\r\n      .reply(reply)\r\n      .catch((err) =>\r\n        message.reply(\r\n          `I don't seem to have permission to send embeds here. The error was \\`${error}\\`.\\n-# Please allow me to send embeds for more detail`\r\n        )\r\n      )\r\n      .then((msg) =>\r\n        setTimeout(async () => {\r\n          if (\r\n            message.channel.isTextBased() &&\r\n            \"bulkDelete\" in message.channel\r\n          ) {\r\n            try {\r\n              await message.channel.bulkDelete([msg, message], true);\r\n            } catch {\r\n              msg.delete().catch(() => {});\r\n              message.delete().catch(() => {});\r\n            }\r\n          } else {\r\n            msg.delete().catch(() => {});\r\n            message.delete().catch(() => {});\r\n          }\r\n        }, 60 * 1000)\r\n      );\r\n  }\r\n\r\n  try {\r\n    command.execute(client, data, message, parsedArgs);\r\n  } catch (err: any) {\r\n    logger.error(\"Command error\", err);\r\n    message.reply(\r\n      (\r\n        await onError(err, {\r\n          command: commandName,\r\n          args,\r\n          user: message.author.id,\r\n          server: message.guild?.id || \"DMs\",\r\n        })\r\n      ).discordMsg\r\n    );\r\n  }\r\n};\r\n"],"names":[],"mappings":"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","debug_id":"dab2bbde-ff0f-5991-b77c-303e09057e7a"}