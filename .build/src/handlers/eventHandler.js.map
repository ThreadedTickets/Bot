{"version":3,"file":"eventHandler.js","sources":["src/handlers/eventHandler.ts"],"sourceRoot":"/","sourcesContent":["import path from \"path\";\r\nimport { loadFilesRecursively } from \"../utils/commands/load\";\r\nimport { getCache } from \"../utils/database/getCachedElse\";\r\nimport { Locale } from \"../types/Locale\";\r\nimport { getServerLocale } from \"../utils/bot/getServer\";\r\n\r\nexport type EventData = {\r\n  blacklist?: {\r\n    active: boolean;\r\n    type: \"user\" | \"server\";\r\n    reason: string;\r\n  };\r\n  lang?: Locale;\r\n};\r\n\r\nexport const loadEvents = async (client: {\r\n  once: (eventName: string, listener: (...args: any[]) => any) => void;\r\n  on: (eventName: string, listener: (...args: any[]) => any) => void;\r\n}) => {\r\n  const eventFiles = loadFilesRecursively(path.join(__dirname, \"../events\"));\r\n\r\n  for (const file of eventFiles) {\r\n    const event = (await import(file)).default;\r\n\r\n    const listener = async (...args: any[]) => {\r\n      const userId = extractUserId(args);\r\n      const guildId = extractGuildId(args);\r\n\r\n      if (!userId && !guildId) {\r\n        return event.execute(client, {} as EventData, ...args);\r\n      }\r\n\r\n      let blacklist = null;\r\n      let lang = null;\r\n      if (userId) {\r\n        const blacklists = await getCache(`blacklists:${userId}`);\r\n        if (blacklists.cached) {\r\n          blacklist = {\r\n            active: true,\r\n            reason: blacklists.data,\r\n            type: \"user\",\r\n          };\r\n        }\r\n      }\r\n\r\n      if (guildId) {\r\n        if (!blacklist) {\r\n          const blacklists = await getCache(`blacklists:${guildId}`);\r\n          if (blacklists.cached) {\r\n            blacklist = {\r\n              active: true,\r\n              reason: blacklists.data,\r\n              type: \"server\",\r\n            };\r\n          }\r\n        }\r\n\r\n        lang = await getServerLocale(guildId);\r\n      }\r\n\r\n      await event.execute(client, { blacklist, lang } as EventData, ...args);\r\n    };\r\n\r\n    if (event.once) {\r\n      client.once(event.name, listener);\r\n    } else {\r\n      client.on(event.name, listener);\r\n    }\r\n  }\r\n};\r\n\r\nfunction extractUserId(args: any[]): string | null {\r\n  for (const arg of args) {\r\n    if (!arg) continue;\r\n    if (\"author\" in arg && arg.author?.id) return arg.author.id; // message\r\n    if (\"user\" in arg && arg.user?.id) return arg.user.id; // member\r\n    if (\"id\" in arg && !(\"guild\" in arg)) return arg.id; // user object\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction extractGuildId(args: any[]): string | null {\r\n  for (const arg of args) {\r\n    if (!arg) continue;\r\n    if (\"guildId\" in arg && typeof arg.guildId === \"string\") return arg.guildId;\r\n    if (\"guild\" in arg && arg.guild?.id) return arg.guild.id;\r\n    if (\"id\" in arg && \"members\" in arg && \"name\" in arg) return arg.id; // guild object\r\n  }\r\n  return null;\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"2c5a118c-94c6-59c5-993a-cde0d257c2aa"}