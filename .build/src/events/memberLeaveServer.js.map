{"version":3,"file":"memberLeaveServer.js","sources":["src/events/memberLeaveServer.ts"],"sourceRoot":"/","sourcesContent":["import { massCloseManager } from \"..\";\nimport { Event } from \"../types/Event\";\nimport { getUserTickets } from \"../utils/bot/getServer\";\nimport { invalidateCache } from \"../utils/database/invalidateCache\";\nimport { closeTicket } from \"../utils/tickets/close\";\nimport { formatDuration } from \"../utils/formatters/duration\";\nimport logger from \"../utils/logger\";\n\nconst event: Event<\"guildMemberRemove\"> = {\n  name: \"guildMemberRemove\",\n  async execute(client, data, member) {\n    const start = new Date().getTime();\n    const user = member;\n    await invalidateCache(`tickets:${member.guild.id}:${user.id}:Locked|Open`);\n    const userTickets = (\n      await getUserTickets(member.guild.id, user.id, [\"Open\", \"Locked\"])\n    ).filter((t) => t.closeOnLeave);\n\n    if (!userTickets.length) return;\n\n    let failed = userTickets.length;\n\n    massCloseManager.wrap(async () => {\n      for (const ticket of userTickets) {\n        const a = await massCloseManager.wrap(async () => {\n          await closeTicket(ticket._id, data?.lang ?? \"en\");\n          return true;\n        });\n        if (a) failed--;\n      }\n    }, member.guild.id);\n\n    logger.debug(\n      `Finished mass close of ${userTickets.length} tickets in ${\n        member.guild.name\n      }. Took ${formatDuration(new Date().getTime() - start)}`,\n      { user: user.id }\n    );\n  },\n};\n\nexport default event;\n"],"names":[],"mappings":";;;;;;;AAAA,0BAAsC;AAEtC,sDAAwD;AACxD,uEAAoE;AACpE,kDAAqD;AACrD,2DAA8D;AAC9D,6DAAqC;AAErC,MAAM,KAAK,GAA+B;IACxC,IAAI,EAAE,mBAAmB;IACzB,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM;QAChC,MAAM,KAAK,GAAG,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,CAAC;QACnC,MAAM,IAAI,GAAG,MAAM,CAAC;QACpB,MAAM,IAAA,iCAAe,EAAC,WAAW,MAAM,CAAC,KAAK,CAAC,EAAE,IAAI,IAAI,CAAC,EAAE,cAAc,CAAC,CAAC;QAC3E,MAAM,WAAW,GAAG,CAClB,MAAM,IAAA,0BAAc,EAAC,MAAM,CAAC,KAAK,CAAC,EAAE,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC,CACnE,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC;QAEhC,IAAI,CAAC,WAAW,CAAC,MAAM;YAAE,OAAO;QAEhC,IAAI,MAAM,GAAG,WAAW,CAAC,MAAM,CAAC;QAEhC,oBAAgB,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE;YAC/B,KAAK,MAAM,MAAM,IAAI,WAAW,EAAE,CAAC;gBACjC,MAAM,CAAC,GAAG,MAAM,oBAAgB,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE;oBAC/C,MAAM,IAAA,mBAAW,EAAC,MAAM,CAAC,GAAG,EAAE,IAAI,EAAE,IAAI,IAAI,IAAI,CAAC,CAAC;oBAClD,OAAO,IAAI,CAAC;gBACd,CAAC,CAAC,CAAC;gBACH,IAAI,CAAC;oBAAE,MAAM,EAAE,CAAC;YAClB,CAAC;QACH,CAAC,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;QAEpB,gBAAM,CAAC,KAAK,CACV,0BAA0B,WAAW,CAAC,MAAM,eAC1C,MAAM,CAAC,KAAK,CAAC,IACf,UAAU,IAAA,yBAAc,EAAC,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,GAAG,KAAK,CAAC,EAAE,EACxD,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAClB,CAAC;IACJ,CAAC;CACF,CAAC;AAEF,kBAAe,KAAK,CAAC","debug_id":"395b1d4b-8c4d-5ae3-98cd-36d64a325d33"}