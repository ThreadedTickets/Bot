{"version":3,"file":"handleIncommingApplicationDm.js","sources":["src/events/handleIncommingApplicationDm.ts"],"sourceRoot":"/","sourcesContent":["import { ActionRowBuilder, ButtonBuilder, ButtonStyle } from \"discord.js\";\nimport colours from \"../constants/colours\";\nimport { t } from \"../lang\";\nimport { Application } from \"../types/Application\";\nimport { Event } from \"../types/Event\";\nimport { generateQuestionMessage } from \"../utils/applications/generateQuestionMessage\";\nimport { handleApplicationSubmit } from \"../utils/applications/handleApplicationSubmit\";\nimport { getServerApplication, getServerMessage } from \"../utils/bot/getServer\";\nimport { getCache } from \"../utils/database/getCachedElse\";\nimport { invalidateCache } from \"../utils/database/invalidateCache\";\nimport { updateCachedData } from \"../utils/database/updateCache\";\nimport { toTimeUnit } from \"../utils/formatters/toTimeUnit\";\nimport { resolveDiscordMessagePlaceholders } from \"../utils/message/placeholders/resolvePlaceholders\";\nimport { onError } from \"../utils/onError\";\n\nconst event: Event<\"messageCreate\"> = {\n  name: \"messageCreate\",\n  once: false,\n  async execute(client, data, message) {\n    if (message.guild) return;\n    if (message.author.bot) return;\n\n    const activeApplication = await getCache(\n      `runningApplications:${message.author.id}`\n    );\n    // console.log(\"Result:\", activeApplication);\n    // console.log(\"Raw data:\", JSON.stringify(activeApplication.data, null, 2));\n\n    if (!activeApplication.cached)\n      return message.reply(\n        (await onError(new Error(t(data!.lang!, `ERROR_CODE_1008`)))).discordMsg\n      );\n\n    const appJson = activeApplication.data;\n    const { applicationId, server } = appJson;\n    const application = await getServerApplication(applicationId, server);\n    if (!application)\n      return message.reply(\n        (await onError(new Error(\"Application not found\"))).discordMsg\n      );\n\n    const selection = message.content;\n    // Now validate the content\n\n    const currentQuestion = appJson.questions[appJson.questionNumber];\n\n    if (selection.toLocaleLowerCase() === \"cancel\") {\n      let baseMessage: {\n        content?: string;\n        embeds?: any[];\n        components?: any[];\n      } = {\n        embeds: [\n          {\n            title: \"{applicationName}\",\n            color: parseInt(colours.primary, 16),\n            description: t(data?.lang!, \"APPLICATION_DEFAULT_MESSAGE_CANCELED\"),\n          },\n        ],\n      };\n\n      const customMessage = application.cancelMessage\n        ? await getServerMessage(application.cancelMessage, application.server)\n        : null;\n\n      if (customMessage) {\n        baseMessage = {\n          content: customMessage.content,\n          embeds: customMessage.embeds,\n        };\n      }\n\n      await invalidateCache(`runningApplications:${message.author.id}`);\n\n      return message.reply({\n        components: [\n          new ActionRowBuilder<ButtonBuilder>()\n            .addComponents(\n              new ButtonBuilder()\n                .setURL(process.env[\"DISCORD_APPLICATION_INVITE\"]!)\n                .setStyle(ButtonStyle.Link)\n                .setLabel(\n                  t(data?.lang!, \"APPLICATION_DEFAULT_MESSAGE_SUBMITTED_BUTTON\")\n                )\n            )\n            .toJSON(),\n        ],\n        ...resolveDiscordMessagePlaceholders(baseMessage, {\n          applicationName: application.name,\n        }),\n      });\n    }\n\n    if (currentQuestion.type === \"choice\") return;\n\n    if (currentQuestion.type === \"text\") {\n      if (message.attachments.size > 0)\n        return message.reply(\n          (await onError(new Error(t(data!.lang!, `ERROR_CODE_1014`))))\n            .discordMsg\n        );\n      if (currentQuestion.minimum && selection.length < currentQuestion.minimum)\n        return message.reply(\n          (\n            await onError(\n              new Error(\n                t(data!.lang!, `ERROR_CODE_1009`, {\n                  min: currentQuestion.minimum,\n                })\n              )\n            )\n          ).discordMsg\n        );\n\n      if (currentQuestion.maximum && selection.length > currentQuestion.maximum)\n        return message.reply(\n          (\n            await onError(\n              new Error(\n                t(data!.lang!, `ERROR_CODE_1010`, {\n                  max: currentQuestion.maximum,\n                })\n              )\n            )\n          ).discordMsg\n        );\n    } else if (currentQuestion.type === \"number\") {\n      if (isNaN(parseInt(selection)))\n        return message.reply(\n          (\n            await onError(\n              new Error(\n                t(data!.lang!, `ERROR_CODE_1013`, {\n                  min: currentQuestion.minimum,\n                })\n              )\n            )\n          ).discordMsg\n        );\n      if (\n        currentQuestion.minimum &&\n        parseFloat(selection) < currentQuestion.minimum\n      )\n        return message.reply(\n          (\n            await onError(\n              new Error(\n                t(data!.lang!, `ERROR_CODE_1011`, {\n                  min: currentQuestion.minimum,\n                })\n              )\n            )\n          ).discordMsg\n        );\n\n      if (\n        currentQuestion.maximum &&\n        parseFloat(selection) > currentQuestion.maximum\n      )\n        return message.reply(\n          (\n            await onError(\n              new Error(\n                t(data!.lang!, `ERROR_CODE_1012`, {\n                  max: currentQuestion.maximum,\n                })\n              )\n            )\n          ).discordMsg\n        );\n    }\n\n    const newCache = {\n      ...appJson,\n      questionNumber: appJson.questionNumber + 1,\n      responses: [\n        ...appJson.responses,\n        {\n          question: appJson.questions[appJson.questionNumber].question,\n          response: selection,\n        },\n      ],\n    };\n\n    updateCachedData(\n      `runningApplications:${message.author.id}`,\n      toTimeUnit(\"seconds\", 0, 0, 0, 1),\n      newCache\n    );\n\n    const appObject = application.toObject();\n    const applicationTyped: Application = {\n      ...appObject,\n      open: appObject.open?.toISOString() ?? null,\n      close: appObject.close?.toISOString() ?? null,\n      acceptedMessage: appObject.acceptedMessage ?? null,\n      rejectedMessage: appObject.rejectedMessage ?? null,\n      submissionMessage: appObject.submissionMessage ?? null,\n      cancelMessage: appObject.cancelMessage ?? null,\n      confirmationMessage: appObject.confirmationMessage ?? null,\n    };\n\n    // Reached the end of the app\n    if (newCache.questionNumber >= newCache.questions.length) {\n      let baseMessage: {\n        content?: string;\n        embeds?: any[];\n        components?: any[];\n      } = {\n        embeds: [\n          {\n            title: \"{applicationName}\",\n            color: parseInt(colours.primary, 16),\n            description: t(\n              data?.lang!,\n              \"APPLICATION_DEFAULT_MESSAGE_SUBMITTED\"\n            ),\n          },\n        ],\n        components: [\n          new ActionRowBuilder<ButtonBuilder>()\n            .addComponents(\n              new ButtonBuilder()\n                .setURL(process.env[\"DISCORD_APPLICATION_INVITE\"]!)\n                .setStyle(ButtonStyle.Link)\n                .setLabel(\n                  t(data?.lang!, \"APPLICATION_DEFAULT_MESSAGE_SUBMITTED_BUTTON\")\n                )\n            )\n            .toJSON(),\n        ],\n      };\n\n      const customMessage = application.submissionMessage\n        ? await getServerMessage(\n            application.submissionMessage,\n            application.server\n          )\n        : null;\n\n      if (customMessage) {\n        baseMessage = {\n          content: customMessage.content,\n          embeds: customMessage.embeds,\n          components: [\n            new ActionRowBuilder<ButtonBuilder>()\n              .addComponents(\n                new ButtonBuilder()\n                  .setURL(process.env[\"DISCORD_APPLICATION_INVITE\"]!)\n                  .setStyle(ButtonStyle.Link)\n                  .setLabel(\n                    t(\n                      data?.lang!,\n                      \"APPLICATION_DEFAULT_MESSAGE_SUBMITTED_BUTTON\"\n                    )\n                  )\n              )\n              .toJSON(),\n          ],\n        };\n      }\n\n      message.author.send(\n        resolveDiscordMessagePlaceholders(baseMessage, {\n          applicationName: application.name,\n        })\n      );\n\n      return handleApplicationSubmit(\n        applicationTyped,\n        newCache,\n        message.author.id,\n        client\n      );\n    }\n\n    message.author.send(\n      await generateQuestionMessage(applicationTyped, newCache.questionNumber)\n    );\n  },\n};\n\nexport default event;\n"],"names":[],"mappings":";;;;;;;AAAA,2CAA0E;AAC1E,mEAA2C;AAC3C,kCAA4B;AAG5B,2FAAwF;AACxF,2FAAwF;AACxF,sDAAgF;AAChF,mEAA2D;AAC3D,uEAAoE;AACpE,+DAAiE;AACjE,+DAA4D;AAC5D,2FAAsG;AACtG,8CAA2C;AAE3C,MAAM,KAAK,GAA2B;IACpC,IAAI,EAAE,eAAe;IACrB,IAAI,EAAE,KAAK;IACX,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO;QACjC,IAAI,OAAO,CAAC,KAAK;YAAE,OAAO;QAC1B,IAAI,OAAO,CAAC,MAAM,CAAC,GAAG;YAAE,OAAO;QAE/B,MAAM,iBAAiB,GAAG,MAAM,IAAA,wBAAQ,EACtC,uBAAuB,OAAO,CAAC,MAAM,CAAC,EAAE,EAAE,CAC3C,CAAC;QACF,6CAA6C;QAC7C,6EAA6E;QAE7E,IAAI,CAAC,iBAAiB,CAAC,MAAM;YAC3B,OAAO,OAAO,CAAC,KAAK,CAClB,CAAC,MAAM,IAAA,iBAAO,EAAC,IAAI,KAAK,CAAC,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAC,UAAU,CACzE,CAAC;QAEJ,MAAM,OAAO,GAAG,iBAAiB,CAAC,IAAI,CAAC;QACvC,MAAM,EAAE,aAAa,EAAE,MAAM,EAAE,GAAG,OAAO,CAAC;QAC1C,MAAM,WAAW,GAAG,MAAM,IAAA,gCAAoB,EAAC,aAAa,EAAE,MAAM,CAAC,CAAC;QACtE,IAAI,CAAC,WAAW;YACd,OAAO,OAAO,CAAC,KAAK,CAClB,CAAC,MAAM,IAAA,iBAAO,EAAC,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC,CAAC,CAAC,UAAU,CAC/D,CAAC;QAEJ,MAAM,SAAS,GAAG,OAAO,CAAC,OAAO,CAAC;QAClC,2BAA2B;QAE3B,MAAM,eAAe,GAAG,OAAO,CAAC,SAAS,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QAElE,IAAI,SAAS,CAAC,iBAAiB,EAAE,KAAK,QAAQ,EAAE,CAAC;YAC/C,IAAI,WAAW,GAIX;gBACF,MAAM,EAAE;oBACN;wBACE,KAAK,EAAE,mBAAmB;wBAC1B,KAAK,EAAE,QAAQ,CAAC,iBAAO,CAAC,OAAO,EAAE,EAAE,CAAC;wBACpC,WAAW,EAAE,IAAA,QAAC,EAAC,IAAI,EAAE,IAAK,EAAE,sCAAsC,CAAC;qBACpE;iBACF;aACF,CAAC;YAEF,MAAM,aAAa,GAAG,WAAW,CAAC,aAAa;gBAC7C,CAAC,CAAC,MAAM,IAAA,4BAAgB,EAAC,WAAW,CAAC,aAAa,EAAE,WAAW,CAAC,MAAM,CAAC;gBACvE,CAAC,CAAC,IAAI,CAAC;YAET,IAAI,aAAa,EAAE,CAAC;gBAClB,WAAW,GAAG;oBACZ,OAAO,EAAE,aAAa,CAAC,OAAO;oBAC9B,MAAM,EAAE,aAAa,CAAC,MAAM;iBAC7B,CAAC;YACJ,CAAC;YAED,MAAM,IAAA,iCAAe,EAAC,uBAAuB,OAAO,CAAC,MAAM,CAAC,EAAE,EAAE,CAAC,CAAC;YAElE,OAAO,OAAO,CAAC,KAAK,CAAC;gBACnB,UAAU,EAAE;oBACV,IAAI,6BAAgB,EAAiB;yBAClC,aAAa,CACZ,IAAI,0BAAa,EAAE;yBAChB,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,4BAA4B,CAAE,CAAC;yBAClD,QAAQ,CAAC,wBAAW,CAAC,IAAI,CAAC;yBAC1B,QAAQ,CACP,IAAA,QAAC,EAAC,IAAI,EAAE,IAAK,EAAE,8CAA8C,CAAC,CAC/D,CACJ;yBACA,MAAM,EAAE;iBACZ;gBACD,GAAG,IAAA,uDAAiC,EAAC,WAAW,EAAE;oBAChD,eAAe,EAAE,WAAW,CAAC,IAAI;iBAClC,CAAC;aACH,CAAC,CAAC;QACL,CAAC;QAED,IAAI,eAAe,CAAC,IAAI,KAAK,QAAQ;YAAE,OAAO;QAE9C,IAAI,eAAe,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;YACpC,IAAI,OAAO,CAAC,WAAW,CAAC,IAAI,GAAG,CAAC;gBAC9B,OAAO,OAAO,CAAC,KAAK,CAClB,CAAC,MAAM,IAAA,iBAAO,EAAC,IAAI,KAAK,CAAC,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,CAAC,CAAC,CAAC,CAAC;qBAC1D,UAAU,CACd,CAAC;YACJ,IAAI,eAAe,CAAC,OAAO,IAAI,SAAS,CAAC,MAAM,GAAG,eAAe,CAAC,OAAO;gBACvE,OAAO,OAAO,CAAC,KAAK,CAClB,CACE,MAAM,IAAA,iBAAO,EACX,IAAI,KAAK,CACP,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,EAAE;oBAChC,GAAG,EAAE,eAAe,CAAC,OAAO;iBAC7B,CAAC,CACH,CACF,CACF,CAAC,UAAU,CACb,CAAC;YAEJ,IAAI,eAAe,CAAC,OAAO,IAAI,SAAS,CAAC,MAAM,GAAG,eAAe,CAAC,OAAO;gBACvE,OAAO,OAAO,CAAC,KAAK,CAClB,CACE,MAAM,IAAA,iBAAO,EACX,IAAI,KAAK,CACP,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,EAAE;oBAChC,GAAG,EAAE,eAAe,CAAC,OAAO;iBAC7B,CAAC,CACH,CACF,CACF,CAAC,UAAU,CACb,CAAC;QACN,CAAC;aAAM,IAAI,eAAe,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC7C,IAAI,KAAK,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;gBAC5B,OAAO,OAAO,CAAC,KAAK,CAClB,CACE,MAAM,IAAA,iBAAO,EACX,IAAI,KAAK,CACP,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,EAAE;oBAChC,GAAG,EAAE,eAAe,CAAC,OAAO;iBAC7B,CAAC,CACH,CACF,CACF,CAAC,UAAU,CACb,CAAC;YACJ,IACE,eAAe,CAAC,OAAO;gBACvB,UAAU,CAAC,SAAS,CAAC,GAAG,eAAe,CAAC,OAAO;gBAE/C,OAAO,OAAO,CAAC,KAAK,CAClB,CACE,MAAM,IAAA,iBAAO,EACX,IAAI,KAAK,CACP,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,EAAE;oBAChC,GAAG,EAAE,eAAe,CAAC,OAAO;iBAC7B,CAAC,CACH,CACF,CACF,CAAC,UAAU,CACb,CAAC;YAEJ,IACE,eAAe,CAAC,OAAO;gBACvB,UAAU,CAAC,SAAS,CAAC,GAAG,eAAe,CAAC,OAAO;gBAE/C,OAAO,OAAO,CAAC,KAAK,CAClB,CACE,MAAM,IAAA,iBAAO,EACX,IAAI,KAAK,CACP,IAAA,QAAC,EAAC,IAAK,CAAC,IAAK,EAAE,iBAAiB,EAAE;oBAChC,GAAG,EAAE,eAAe,CAAC,OAAO;iBAC7B,CAAC,CACH,CACF,CACF,CAAC,UAAU,CACb,CAAC;QACN,CAAC;QAED,MAAM,QAAQ,GAAG;YACf,GAAG,OAAO;YACV,cAAc,EAAE,OAAO,CAAC,cAAc,GAAG,CAAC;YAC1C,SAAS,EAAE;gBACT,GAAG,OAAO,CAAC,SAAS;gBACpB;oBACE,QAAQ,EAAE,OAAO,CAAC,SAAS,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,QAAQ;oBAC5D,QAAQ,EAAE,SAAS;iBACpB;aACF;SACF,CAAC;QAEF,IAAA,8BAAgB,EACd,uBAAuB,OAAO,CAAC,MAAM,CAAC,EAAE,EAAE,EAC1C,IAAA,uBAAU,EAAC,SAAS,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,EACjC,QAAQ,CACT,CAAC;QAEF,MAAM,SAAS,GAAG,WAAW,CAAC,QAAQ,EAAE,CAAC;QACzC,MAAM,gBAAgB,GAAgB;YACpC,GAAG,SAAS;YACZ,IAAI,EAAE,SAAS,CAAC,IAAI,EAAE,WAAW,EAAE,IAAI,IAAI;YAC3C,KAAK,EAAE,SAAS,CAAC,KAAK,EAAE,WAAW,EAAE,IAAI,IAAI;YAC7C,eAAe,EAAE,SAAS,CAAC,eAAe,IAAI,IAAI;YAClD,eAAe,EAAE,SAAS,CAAC,eAAe,IAAI,IAAI;YAClD,iBAAiB,EAAE,SAAS,CAAC,iBAAiB,IAAI,IAAI;YACtD,aAAa,EAAE,SAAS,CAAC,aAAa,IAAI,IAAI;YAC9C,mBAAmB,EAAE,SAAS,CAAC,mBAAmB,IAAI,IAAI;SAC3D,CAAC;QAEF,6BAA6B;QAC7B,IAAI,QAAQ,CAAC,cAAc,IAAI,QAAQ,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC;YACzD,IAAI,WAAW,GAIX;gBACF,MAAM,EAAE;oBACN;wBACE,KAAK,EAAE,mBAAmB;wBAC1B,KAAK,EAAE,QAAQ,CAAC,iBAAO,CAAC,OAAO,EAAE,EAAE,CAAC;wBACpC,WAAW,EAAE,IAAA,QAAC,EACZ,IAAI,EAAE,IAAK,EACX,uCAAuC,CACxC;qBACF;iBACF;gBACD,UAAU,EAAE;oBACV,IAAI,6BAAgB,EAAiB;yBAClC,aAAa,CACZ,IAAI,0BAAa,EAAE;yBAChB,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,4BAA4B,CAAE,CAAC;yBAClD,QAAQ,CAAC,wBAAW,CAAC,IAAI,CAAC;yBAC1B,QAAQ,CACP,IAAA,QAAC,EAAC,IAAI,EAAE,IAAK,EAAE,8CAA8C,CAAC,CAC/D,CACJ;yBACA,MAAM,EAAE;iBACZ;aACF,CAAC;YAEF,MAAM,aAAa,GAAG,WAAW,CAAC,iBAAiB;gBACjD,CAAC,CAAC,MAAM,IAAA,4BAAgB,EACpB,WAAW,CAAC,iBAAiB,EAC7B,WAAW,CAAC,MAAM,CACnB;gBACH,CAAC,CAAC,IAAI,CAAC;YAET,IAAI,aAAa,EAAE,CAAC;gBAClB,WAAW,GAAG;oBACZ,OAAO,EAAE,aAAa,CAAC,OAAO;oBAC9B,MAAM,EAAE,aAAa,CAAC,MAAM;oBAC5B,UAAU,EAAE;wBACV,IAAI,6BAAgB,EAAiB;6BAClC,aAAa,CACZ,IAAI,0BAAa,EAAE;6BAChB,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,4BAA4B,CAAE,CAAC;6BAClD,QAAQ,CAAC,wBAAW,CAAC,IAAI,CAAC;6BAC1B,QAAQ,CACP,IAAA,QAAC,EACC,IAAI,EAAE,IAAK,EACX,8CAA8C,CAC/C,CACF,CACJ;6BACA,MAAM,EAAE;qBACZ;iBACF,CAAC;YACJ,CAAC;YAED,OAAO,CAAC,MAAM,CAAC,IAAI,CACjB,IAAA,uDAAiC,EAAC,WAAW,EAAE;gBAC7C,eAAe,EAAE,WAAW,CAAC,IAAI;aAClC,CAAC,CACH,CAAC;YAEF,OAAO,IAAA,iDAAuB,EAC5B,gBAAgB,EAChB,QAAQ,EACR,OAAO,CAAC,MAAM,CAAC,EAAE,EACjB,MAAM,CACP,CAAC;QACJ,CAAC;QAED,OAAO,CAAC,MAAM,CAAC,IAAI,CACjB,MAAM,IAAA,iDAAuB,EAAC,gBAAgB,EAAE,QAAQ,CAAC,cAAc,CAAC,CACzE,CAAC;IACJ,CAAC;CACF,CAAC;AAEF,kBAAe,KAAK,CAAC","debug_id":"ae3234f4-42c9-5ecc-897f-0a6feda346ce"}