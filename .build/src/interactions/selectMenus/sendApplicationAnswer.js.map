{"version":3,"file":"sendApplicationAnswer.js","sources":["src/interactions/selectMenus/sendApplicationAnswer.ts"],"sourceRoot":"/","sourcesContent":["import { ActionRowBuilder, ButtonBuilder, ButtonStyle } from \"discord.js\";\r\nimport colours from \"../../constants/colours\";\r\nimport { t } from \"../../lang\";\r\nimport { Application } from \"../../types/Application\";\r\nimport { SelectMenuHandler } from \"../../types/Interactions\";\r\nimport { generateQuestionMessage } from \"../../utils/applications/generateQuestionMessage\";\r\nimport { handleApplicationSubmit } from \"../../utils/applications/handleApplicationSubmit\";\r\nimport {\r\n  getServerApplication,\r\n  getServerMessage,\r\n} from \"../../utils/bot/getServer\";\r\nimport { getCache } from \"../../utils/database/getCachedElse\";\r\nimport { updateCachedData } from \"../../utils/database/updateCache\";\r\nimport { toTimeUnit } from \"../../utils/formatters/toTimeUnit\";\r\nimport { resolveDiscordMessagePlaceholders } from \"../../utils/message/placeholders/resolvePlaceholders\";\r\nimport { onError } from \"../../utils/onError\";\r\n\r\nconst select: SelectMenuHandler = {\r\n  customId: \"appSubmit\",\r\n  async execute(client, data, interaction) {\r\n    const [, applicationId, guildId] = interaction.customId.split(\":\");\r\n\r\n    const activeApplication = await getCache(\r\n      `runningApplications:${interaction.user.id}`\r\n    );\r\n    if (!activeApplication.cached)\r\n      return interaction.reply(\r\n        (await onError(new Error(t(data.lang!, `ERROR_CODE_1008`)))).discordMsg\r\n      );\r\n\r\n    const appJson = activeApplication.data;\r\n    if (applicationId !== appJson.applicationId)\r\n      return interaction.reply(\r\n        (await onError(new Error(t(data.lang!, `ERROR_CODE_1008`)))).discordMsg\r\n      );\r\n    const application = await getServerApplication(applicationId, guildId);\r\n    if (!application)\r\n      return interaction.reply(\r\n        (await onError(new Error(\"Application not found\"))).discordMsg\r\n      );\r\n\r\n    const selection = interaction.values.join(\", \");\r\n    const newCache = {\r\n      ...appJson,\r\n      questionNumber: appJson.questionNumber + 1,\r\n      responses: [\r\n        ...appJson.responses,\r\n        {\r\n          question: appJson.questions[appJson.questionNumber].question,\r\n          response: selection,\r\n        },\r\n      ],\r\n    };\r\n\r\n    updateCachedData(\r\n      `runningApplications:${interaction.user.id}`,\r\n      toTimeUnit(\"seconds\", 0, 0, 0, 1),\r\n      newCache\r\n    );\r\n\r\n    const appObject = application.toObject();\r\n    const applicationTyped: Application = {\r\n      ...appObject,\r\n      open: appObject.open?.toISOString() ?? null,\r\n      close: appObject.close?.toISOString() ?? null,\r\n      acceptedMessage: appObject.acceptedMessage ?? null,\r\n      rejectedMessage: appObject.rejectedMessage ?? null,\r\n      submissionMessage: appObject.submissionMessage ?? null,\r\n      cancelMessage: appObject.cancelMessage ?? null,\r\n      confirmationMessage: appObject.confirmationMessage ?? null,\r\n    };\r\n\r\n    interaction.message.edit({ components: [] });\r\n    // Reached the end of the app\r\n    if (newCache.questionNumber >= newCache.questions.length) {\r\n      let baseMessage: {\r\n        content?: string;\r\n        embeds?: any[];\r\n        components?: any[];\r\n      } = {\r\n        embeds: [\r\n          {\r\n            title: \"{applicationName}\",\r\n            color: parseInt(colours.primary, 16),\r\n            description: t(\r\n              data?.lang!,\r\n              \"APPLICATION_DEFAULT_MESSAGE_SUBMITTED\"\r\n            ),\r\n          },\r\n        ],\r\n      };\r\n\r\n      const customMessage = application.submissionMessage\r\n        ? await getServerMessage(\r\n            application.submissionMessage,\r\n            application.server\r\n          )\r\n        : null;\r\n\r\n      if (customMessage) {\r\n        baseMessage = {\r\n          content: customMessage.content,\r\n          embeds: customMessage.embeds,\r\n        };\r\n      }\r\n\r\n      interaction.user.send({\r\n        components: [\r\n          new ActionRowBuilder<ButtonBuilder>()\r\n            .addComponents(\r\n              new ButtonBuilder()\r\n                .setURL(process.env[\"DISCORD_APPLICATION_INVITE\"]!)\r\n                .setStyle(ButtonStyle.Link)\r\n                .setLabel(\r\n                  t(data?.lang!, \"APPLICATION_DEFAULT_MESSAGE_SUBMITTED_BUTTON\")\r\n                )\r\n            )\r\n            .toJSON(),\r\n        ],\r\n        ...resolveDiscordMessagePlaceholders(baseMessage, {\r\n          applicationName: application.name,\r\n        }),\r\n      });\r\n\r\n      return handleApplicationSubmit(\r\n        applicationTyped,\r\n        newCache,\r\n        interaction.user.id,\r\n        client\r\n      );\r\n    }\r\n\r\n    interaction.user.send(\r\n      await generateQuestionMessage(applicationTyped, newCache.questionNumber)\r\n    );\r\n  },\r\n};\r\n\r\nexport default select;\r\n"],"names":[],"mappings":"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","debug_id":"6a8caf09-349c-5f01-80d4-54f5a5f67fae"}