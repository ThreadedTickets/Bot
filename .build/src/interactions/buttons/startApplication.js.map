{"version":3,"file":"startApplication.js","sources":["src/interactions/buttons/startApplication.ts"],"sourceRoot":"/","sourcesContent":["import { MessageFlags, User } from \"discord.js\";\r\nimport { t } from \"../../lang\";\r\nimport { Application } from \"../../types/Application\";\r\nimport { ButtonHandler } from \"../../types/Interactions\";\r\nimport { getServerApplication } from \"../../utils/bot/getServer\";\r\nimport { onError } from \"../../utils/onError\";\r\nimport { performApplicationChecks } from \"../../utils/applications/performChecks\";\r\nimport { generateQuestionMessage } from \"../../utils/applications/generateQuestionMessage\";\r\nimport { updateCachedData } from \"../../utils/database/updateCache\";\r\nimport { toTimeUnit } from \"../../utils/formatters/toTimeUnit\";\r\n\r\nconst button: ButtonHandler = {\r\n  customId: \"startApp\",\r\n  async execute(client, data, interaction) {\r\n    const [, applicationId, guildId] = interaction.customId.split(\":\");\r\n    await interaction.reply({\r\n      content: t(data.lang!, \"APPLICATION_PENDING_CHECKS\"),\r\n      flags: [MessageFlags.Ephemeral],\r\n    });\r\n\r\n    const application = await getServerApplication(applicationId, guildId);\r\n    if (!application)\r\n      return interaction.editReply(\r\n        (await onError(new Error(\"Application not found\"))).discordMsg\r\n      );\r\n\r\n    const appObject = application.toObject();\r\n    const applicationTyped: Application = {\r\n      ...appObject,\r\n      open: appObject.open?.toISOString() ?? null,\r\n      close: appObject.close?.toISOString() ?? null,\r\n      acceptedMessage: appObject.acceptedMessage ?? null,\r\n      rejectedMessage: appObject.rejectedMessage ?? null,\r\n      submissionMessage: appObject.submissionMessage ?? null,\r\n      cancelMessage: appObject.cancelMessage ?? null,\r\n      confirmationMessage: appObject.confirmationMessage ?? null,\r\n    };\r\n\r\n    const checks = await performApplicationChecks(\r\n      applicationTyped,\r\n      interaction.user as User,\r\n      true,\r\n      false\r\n    );\r\n\r\n    if (!checks.allowed) {\r\n      return interaction.editReply(\r\n        (await onError(new Error(t(data.lang!, `ERROR_CODE_${checks.error}`))))\r\n          .discordMsg\r\n      );\r\n    }\r\n\r\n    await interaction.deleteReply();\r\n    interaction.message.edit({ components: [] }).catch(() => {});\r\n    interaction.user.send(await generateQuestionMessage(applicationTyped, 0));\r\n    await updateCachedData(\r\n      `runningApplications:${interaction.user.id}`,\r\n      toTimeUnit(\"seconds\", 0, 0, 0, 1),\r\n      {\r\n        applicationId: applicationTyped._id,\r\n        startTime: new Date(),\r\n        server: applicationTyped.server,\r\n        questionNumber: 0,\r\n        questions: applicationTyped.questions,\r\n\r\n        responses: [],\r\n      }\r\n    );\r\n  },\r\n};\r\n\r\nexport default button;\r\n"],"names":[],"mappings":"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","debug_id":"3fd18931-ad05-5291-8fca-316a59e6e424"}