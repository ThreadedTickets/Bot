{"version":3,"file":"deleteApp.js","sources":["src/interactions/buttons/deleteApp.ts"],"sourceRoot":"/","sourcesContent":["import { t } from \"../../lang\";\r\nimport { ButtonHandler } from \"../../types/Interactions\";\r\nimport {\r\n  getCompletedApplication,\r\n  getServer,\r\n  getServerApplication,\r\n  getServerGroupsByIds,\r\n} from \"../../utils/bot/getServer\";\r\nimport { onError } from \"../../utils/onError\";\r\nimport { invalidateCache } from \"../../utils/database/invalidateCache\";\r\nimport {\r\n  getAvailableLogChannel,\r\n  postLogToWebhook,\r\n} from \"../../utils/bot/sendLogToWebhook\";\r\nimport colours from \"../../constants/colours\";\r\nimport { getGuildMember } from \"../../utils/bot/getGuildMember\";\r\nimport { updateMemberRoles } from \"../../utils/hooks/events/applications/end/roles\";\r\nimport { CompletedApplicationSchema } from \"../../database/modals/CompletedApplications\";\r\nimport { getUserPermissions } from \"../../utils/calculateUserPermissions\";\r\nimport { GuildMember, PermissionFlagsBits } from \"discord.js\";\r\n\r\nconst button: ButtonHandler = {\r\n  customId: \"delApp\",\r\n  async execute(client, data, interaction) {\r\n    if (!interaction.guildId) return;\r\n    const [, applicationId, owner] = interaction.customId.split(\":\");\r\n    const application = await getCompletedApplication(applicationId, owner);\r\n    if (!application)\r\n      return interaction.reply(\r\n        (await onError(new Error(\"Application attempt not found\"))).discordMsg\r\n      );\r\n\r\n    if (application.status !== \"Pending\")\r\n      return interaction.reply(\r\n        (await onError(new Error(\"Application already responded\"))).discordMsg\r\n      );\r\n    const applicationTrigger = await getServerApplication(\r\n      application.application,\r\n      interaction.guildId\r\n    );\r\n    if (!applicationTrigger)\r\n      return interaction.reply(\r\n        (await onError(new Error(\"Application not found\"))).discordMsg\r\n      );\r\n    const userPermissions = getUserPermissions(\r\n      interaction.member as GuildMember,\r\n      await getServerGroupsByIds(applicationTrigger.groups, interaction.guildId)\r\n    );\r\n    if (\r\n      !userPermissions.applications.respond &&\r\n      !interaction.memberPermissions?.has(PermissionFlagsBits.ManageGuild)\r\n    )\r\n      return interaction.reply(\r\n        (await onError(new Error(\"Missing respond permission\"))).discordMsg\r\n      );\r\n\r\n    const server = await getServer(interaction.guildId);\r\n\r\n    await interaction.deferUpdate();\r\n    interaction.message.delete().catch(() => {});\r\n    if (interaction.message.hasThread)\r\n      interaction.message.thread?.delete().catch(() => {});\r\n\r\n    await invalidateCache(`completedApps:${applicationTrigger._id}:Pending`);\r\n    await invalidateCache(\r\n      `completedApps:${applicationTrigger._id}:${owner}:all`\r\n    );\r\n    await CompletedApplicationSchema.findOneAndDelete({ _id: applicationId });\r\n\r\n    const member = await getGuildMember(\r\n      client,\r\n      interaction.guildId,\r\n      application.owner\r\n    );\r\n    if (member && applicationTrigger) {\r\n      await updateMemberRoles(\r\n        client,\r\n        member,\r\n        applicationTrigger.removeRolesWhenPending,\r\n        applicationTrigger.addRolesWhenPending\r\n      );\r\n    }\r\n\r\n    const logChannel = getAvailableLogChannel(\r\n      server.settings.logging,\r\n      \"applications.delete\"\r\n    );\r\n    if (!logChannel) return;\r\n\r\n    await postLogToWebhook(\r\n      client,\r\n      {\r\n        channel: logChannel.channel!,\r\n        enabled: logChannel.enabled,\r\n        webhook: logChannel.webhook!,\r\n      },\r\n      {\r\n        embeds: [\r\n          {\r\n            color: parseInt(colours.info, 16),\r\n            title: t(server.preferredLanguage, \"DELETE_APPLICATION_LOG_TITLE\"),\r\n            description: t(\r\n              server.preferredLanguage,\r\n              `DELETE_APPLICATION_LOG_BODY`,\r\n              {\r\n                user: `<@${owner}>`,\r\n                staff: `<@${interaction.user.id}>`,\r\n              }\r\n            ),\r\n          },\r\n        ],\r\n      }\r\n    );\r\n  },\r\n};\r\n\r\nexport default button;\r\n"],"names":[],"mappings":"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","debug_id":"3541d9f6-f95c-5125-be02-98a1ff8c3f55"}