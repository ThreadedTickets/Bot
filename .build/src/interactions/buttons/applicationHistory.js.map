{"version":3,"file":"applicationHistory.js","sources":["src/interactions/buttons/applicationHistory.ts"],"sourceRoot":"/","sourcesContent":["import { GuildMember, MessageFlags, PermissionFlagsBits } from \"discord.js\";\nimport { ButtonHandler } from \"../../types/Interactions\";\nimport { t } from \"../../lang\";\nimport {\n  getServerApplication,\n  getServerGroupsByIds,\n  getUserCompletedApplications,\n} from \"../../utils/bot/getServer\";\nimport { paginateStrings } from \"../../utils/formatters/paginateStrings\";\nimport { paginateWithButtons } from \"../../utils/paginateWithButtons\";\nimport { getUserPermissions } from \"../../utils/calculateUserPermissions\";\nimport { onError } from \"../../utils/onError\";\n\nconst button: ButtonHandler = {\n  customId: \"appHistory\",\n  async execute(client, data, interaction) {\n    if (!interaction.guildId) return;\n    await interaction.reply({\n      content: t(data.lang!, \"THINK\"),\n      flags: [MessageFlags.Ephemeral],\n    });\n\n    const [, applicationId, userId] = interaction.customId.split(\":\");\n    const application = await getServerApplication(\n      applicationId,\n      interaction.guildId\n    );\n    if (!application)\n      return interaction.editReply(\n        (\n          await onError(new Error(\"Application not found\"), {\n            applicationId,\n            guildId: interaction.guildId,\n          })\n        ).discordMsg\n      );\n    const userPermissions = getUserPermissions(\n      interaction.member as GuildMember,\n      await getServerGroupsByIds(application.groups, interaction.guildId)\n    );\n\n    if (\n      !userPermissions.applications.manage &&\n      !userPermissions.applications.respond &&\n      !interaction.memberPermissions?.has(PermissionFlagsBits.ManageGuild)\n    )\n      return interaction.editReply(\n        (await onError(new Error(\"Missing manage/respond permission\")))\n          .discordMsg\n      );\n\n    const allApplications = await getUserCompletedApplications(\n      application._id,\n      userId\n    );\n    const applicationHistoryStrings = allApplications\n      .map(\n        (a) =>\n          `<t:${Math.round(\n            new Date(a.createdAt).getTime() / 1000\n          )}:f>\\n> Attempt ID: \\`${a._id}\\`\\n> Status: ${\n            a.messageLink\n              ? `[\\`${a.status}\\`](${a.messageLink})`\n              : `\\`${a.status}\\``\n          }\\n`\n      )\n      .reverse();\n\n    const paginatedMessages = paginateStrings(\n      applicationHistoryStrings,\n      5,\n      `Applications for ${application?.name ?? \"`Unknown application`\"}`\n    );\n\n    await paginateWithButtons(\n      interaction.user.id,\n      interaction,\n      paginatedMessages\n    );\n  },\n};\n\nexport default button;\n"],"names":[],"mappings":";;;;AAAA,2CAA4E;AAE5E,qCAA+B;AAC/B,yDAImC;AACnC,4EAAyE;AACzE,yEAAsE;AACtE,mFAA0E;AAC1E,iDAA8C;AAE9C,MAAM,MAAM,GAAkB;IAC5B,QAAQ,EAAE,YAAY;IACtB,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,IAAI,EAAE,WAAW;QACrC,IAAI,CAAC,WAAW,CAAC,OAAO;YAAE,OAAO;QACjC,MAAM,WAAW,CAAC,KAAK,CAAC;YACtB,OAAO,EAAE,IAAA,QAAC,EAAC,IAAI,CAAC,IAAK,EAAE,OAAO,CAAC;YAC/B,KAAK,EAAE,CAAC,yBAAY,CAAC,SAAS,CAAC;SAChC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,aAAa,EAAE,MAAM,CAAC,GAAG,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAClE,MAAM,WAAW,GAAG,MAAM,IAAA,gCAAoB,EAC5C,aAAa,EACb,WAAW,CAAC,OAAO,CACpB,CAAC;QACF,IAAI,CAAC,WAAW;YACd,OAAO,WAAW,CAAC,SAAS,CAC1B,CACE,MAAM,IAAA,iBAAO,EAAC,IAAI,KAAK,CAAC,uBAAuB,CAAC,EAAE;gBAChD,aAAa;gBACb,OAAO,EAAE,WAAW,CAAC,OAAO;aAC7B,CAAC,CACH,CAAC,UAAU,CACb,CAAC;QACJ,MAAM,eAAe,GAAG,IAAA,6CAAkB,EACxC,WAAW,CAAC,MAAqB,EACjC,MAAM,IAAA,gCAAoB,EAAC,WAAW,CAAC,MAAM,EAAE,WAAW,CAAC,OAAO,CAAC,CACpE,CAAC;QAEF,IACE,CAAC,eAAe,CAAC,YAAY,CAAC,MAAM;YACpC,CAAC,eAAe,CAAC,YAAY,CAAC,OAAO;YACrC,CAAC,WAAW,CAAC,iBAAiB,EAAE,GAAG,CAAC,gCAAmB,CAAC,WAAW,CAAC;YAEpE,OAAO,WAAW,CAAC,SAAS,CAC1B,CAAC,MAAM,IAAA,iBAAO,EAAC,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC,CAAC;iBAC5D,UAAU,CACd,CAAC;QAEJ,MAAM,eAAe,GAAG,MAAM,IAAA,wCAA4B,EACxD,WAAW,CAAC,GAAG,EACf,MAAM,CACP,CAAC;QACF,MAAM,yBAAyB,GAAG,eAAe;aAC9C,GAAG,CACF,CAAC,CAAC,EAAE,EAAE,CACJ,MAAM,IAAI,CAAC,KAAK,CACd,IAAI,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CACvC,wBAAwB,CAAC,CAAC,GAAG,iBAC5B,CAAC,CAAC,WAAW;YACX,CAAC,CAAC,MAAM,CAAC,CAAC,MAAM,OAAO,CAAC,CAAC,WAAW,GAAG;YACvC,CAAC,CAAC,KAAK,CAAC,CAAC,MAAM,IACnB,IAAI,CACP;aACA,OAAO,EAAE,CAAC;QAEb,MAAM,iBAAiB,GAAG,IAAA,iCAAe,EACvC,yBAAyB,EACzB,CAAC,EACD,oBAAoB,WAAW,EAAE,IAAI,IAAI,uBAAuB,EAAE,CACnE,CAAC;QAEF,MAAM,IAAA,yCAAmB,EACvB,WAAW,CAAC,IAAI,CAAC,EAAE,EACnB,WAAW,EACX,iBAAiB,CAClB,CAAC;IACJ,CAAC;CACF,CAAC;AAEF,kBAAe,MAAM,CAAC","debug_id":"a5f05dd5-4577-5593-9371-3f47f7ea3f7d"}